plugins {
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
    id 'edu.sc.seis.launch4j' version '3.0.7'
    id 'de.inetsoftware.jwebassembly' version '1.4.1'
    id 'org.beryx.jlink' version '3.0.1'
    // id 'de.inetsoftware.jwebassembly' version 'master-SNAPSHOT'
}

repositories {
    mavenCentral()
}

dependencies {
    // Use JUnit Jupiter for testing.
    testImplementation libs.junit.jupiter

    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    implementation libs.guava
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.17.0'

    // JavaFX依赖由插件自动管理，无需手动声明
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

application {
    mainClass = 'javafx_demo.App'
}

javafx {
    version = "21.0.3"
    modules = [ 'javafx.controls', 'javafx.fxml' ]
}
// jlink 配置示例：项目模块化后可用（需要 module-info.java）
jlink {
    options = ['--strip-debug', '--compress', '2', '--no-header-files', '--no-man-pages']
    imageName = 'env'
    launcher {
        name = '未来电竞打手端' // 生成的可执行文件名
        // 为运行时添加 JVM 参数，例如启用 ZGC（Java 21）
        jvmArgs = ['-XX:+UseZGC']
    }
}

launch4j {
    mainClassName = 'javafx_demo.App'
    outfile = '未来电竞打手端.exe'
    productName="未来电竞打手端"
    icon = "${projectDir}/src/main/resources/icon.ico"
    bundledJrePath = './env'
}

tasks.register('pack', Copy) {
    group = "distribution"
    description = "整合 JRE 和 EXE 到一个发布文件夹"
    
    def isWindows = System.getProperty('os.name').toLowerCase().contains('windows')
    
    // 1. 确保先生成了 JRE；EXE 仅在 Windows 上生成
    if (isWindows) {
        dependsOn(['jlink', 'createExe'])
    } else {
        dependsOn(['jlink'])
    }
    
    // 2. 定义输出目录
    into "${buildDir}/dist/pal_ending_app"
    
    // 3. 拷贝 jlink 生成的内容到 env 子目录
    from("${buildDir}/env") {
        into 'env'
    }
    
    // 4. 仅 Windows 下拷贝 exe
    if (isWindows) {
        from("${buildDir}/launch4j/${launch4j.outfile}")
    }
    
    doLast {
        println "打包完成！请查看目录: ${buildDir}/dist/pal_ending_app"
        if (!isWindows) {
            println "注意: 当前为非 Windows 环境，未生成 .exe 文件。请在 Windows 上运行 './gradlew pack' 以生成完整发布包。"
        }
    }
}

tasks.named('test') {
    useJUnitPlatform()
}
